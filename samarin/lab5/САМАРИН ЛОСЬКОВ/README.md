# Проект: Генерация коротких мульт-видео и их оценка через Webench2

Проект для генерации коротких мульт-видео по текстовому описанию сцен с использованием Stable Video Diffusion и оценки качества через Webench2.

## Описание

Сервис принимает текстовый запрос (например, "кот-программист бежит по коду, вокруг всплывают окна ошибок") и генерирует короткий ролик 10–30 секунд с несколькими сценами. На выходе - видео без звука, только картинка.

Webench2 используется как "полигон испытаний" для измерения качества роликов при разных версиях моделей и настроек пайплайна.

## Архитектура

### Компоненты

1. **Backend генерации видео** (`backend/`)
   - Обёртка над Stable Video Diffusion
   - Пайплайн генерации клипов по текстовому описанию
   - Интеграция с ComfyUI

2. **Webench2 интеграция** (`webench2/`)
   - Разбор видео на кадры
   - Оценка соответствия тексту (CLIPScore)
   - Оценка визуального качества (ImageReward)
   - Метрики стабильности и качества

3. **Эталонные промпты** (`prompts/`)
   - Набор фиксированных промптов для регрессионного бенчмарка
   - Конфигурация тестовых сценариев

4. **Интерфейс аналитики** (`frontend/`)
   - Визуализация метрик
   - A/B сравнение моделей
   - Отчёты по экспериментам

## Модели

- **Генерация видео**: 
  - `stabilityai/stable-video-diffusion-img2vid-xt`
  - `stabilityai/stable-video-diffusion-img2vid-xt-1-1`

- **Оценка соответствия тексту**: 
  - `openai/clip-vit-base-patch32`

- **Оценка визуального качества**: 
  - `BAAI/ImageReward`

## Установка

```bash
pip install -r requirements.txt
```

**Примечание:** CLIP доступен через библиотеку `transformers`, отдельный пакет `clip-by-openai` не требуется (и конфликтует с современными версиями PyTorch).

## Быстрый старт

Подробные инструкции по установке см. в [INSTALL.md](INSTALL.md)

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Установите и запустите ComfyUI (см. INSTALL.md)

3. Запустите генерацию и оценку:
```bash
python main.py full "кот-программист бежит по коду, вокруг всплывают окна ошибок"
```

## Использование

### Командная строка

#### Генерация и оценка видео
```bash
python main.py full "текстовое описание сцены"
```

#### Только генерация
```bash
python main.py generate "текстовое описание сцены" --output video.mp4
```

#### Только оценка
```bash
python main.py evaluate path/to/video.mp4 "текстовое описание"
```

#### Регрессионный бенчмарк
```bash
python main.py benchmark --version v1.0
# или
python run_benchmark.py
```

#### Сравнение моделей
```bash
python main.py compare results/benchmark/run_a.json results/benchmark/run_b.json
```

### Программный интерфейс

#### Генерация видео
```python
from backend.video_generator import VideoGenerator

generator = VideoGenerator()
video_path = generator.generate_from_text("кот-программист бежит по коду, вокруг всплывают окна ошибок")
```

#### Оценка через Webench2
```python
from webench2.evaluator import Webench2Evaluator

evaluator = Webench2Evaluator()
metrics = evaluator.evaluate_video(video_path, prompt_text)
print(f"Quality Index: {metrics['quality_index']:.3f}")
```

#### Запуск регрессионного бенчмарка
```python
from webench2.benchmark import run_regression_benchmark

results = run_regression_benchmark(model_version="v1.0")
```

### Веб-интерфейс

Запустите веб-интерфейс для визуализации результатов:

```bash
python run_web.py
# или
cd frontend && python app.py
```

Откройте браузер и перейдите на `http://localhost:5000`

## Структура проекта

```
САМАРИН ЛОСЬКОВ/
├── backend/              # Пайплайн генерации видео
│   ├── video_generator.py    # Основной генератор
│   ├── keyframe_generator.py # Генератор ключевых кадров
│   └── comfyui_client.py     # Клиент для ComfyUI
├── webench2/            # Интеграция с Webench2
│   ├── evaluator.py          # Оценщик видео
│   ├── metrics.py             # Калькулятор метрик
│   └── benchmark.py           # Регрессионный бенчмарк
├── prompts/             # Эталонные промпты
│   └── benchmark_prompts.json # Набор промптов для бенчмарка
├── frontend/            # Интерфейс аналитики
│   ├── app.py                # Flask приложение
│   └── templates/            # HTML шаблоны
├── config/              # Конфигурационные файлы
│   └── config.yaml           # Основная конфигурация
├── outputs/             # Сгенерированные видео (создаётся автоматически)
│   ├── keyframes/            # Ключевые кадры
│   └── videos/               # Готовые видео
├── results/             # Результаты оценки (создаётся автоматически)
│   ├── benchmark/            # Результаты бенчмарков
│   └── comparisons/          # Результаты сравнений
├── main.py              # Главный скрипт
├── run_benchmark.py     # Скрипт для запуска бенчмарка
├── run_web.py           # Скрипт для запуска веб-интерфейса
├── example_usage.py     # Примеры использования
├── requirements.txt     # Зависимости Python
├── README.md            # Этот файл
└── INSTALL.md           # Инструкция по установке
```

## Метрики Webench2

Проект вычисляет следующие метрики:

- **CLIPScore** - соответствие кадров текстовому описанию
  - Средний, минимальный, максимальный CLIPScore
  - Дисперсия (показатель стабильности)

- **ImageReward** - визуальное качество кадров
  - Средняя оценка качества по выборке кадров

- **Технические проверки**:
  - Статичные кадры (одинаковые подряд)
  - Тёмные кадры
  - Пересвеченные кадры
  - Резкие скачки яркости

- **Quality Index** - сводный индекс качества (0-1)

## Режимы работы

### Регрессионный бенчмарк
Запускает генерацию и оценку на наборе фиксированных промптов. Позволяет отслеживать изменения качества при обновлении моделей или настроек.

### A/B сравнение моделей
Сравнивает результаты двух версий модели и показывает дельты по всем метрикам.

### Веб-интерфейс
Визуализация результатов, графики метрик, просмотр видео с оценками.

## Лицензия

MIT
